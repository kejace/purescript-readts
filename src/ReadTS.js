"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var ts = require("typescript");
function readTypes(configFilename, include) {
    var configJson = ts.parseConfigFileTextToJson(configFilename, ts.sys.readFile(configFilename)).config;
    var config = ts.parseJsonConfigFileContent(configJson, ts.sys, configFilename.replace(/[^/]+$/, ''), {}, configFilename);
    var program = ts.createProgram(config.fileNames, config.options);
    var checker = program.getTypeChecker();
    var output = [];
    for (var _i = 0, _a = program.getSourceFiles(); _i < _a.length; _i++) {
        var sourceFile = _a[_i];
        ts.forEachChild(sourceFile, visit(sourceFile.fileName));
    }
    return output;
    function visit(fileName) {
        return function (node) {
            if (!isNodeExported(node)) {
                return;
            }
            if (ts.isInterfaceDeclaration(node) && include(fileName, node.name.text)) {
                var symbol = checker.getSymbolAtLocation(node.name);
                if (symbol) {
                    var nodeType = checker.getTypeAtLocation(node);
                    if (nodeType.isClassOrInterface()) {
                        var members = convertProperties(nodeType, node);
                        output.push({ type: "interface", name: node.name.text, members: members });
                    }
                }
            }
            else if (ts.isModuleDeclaration(node)) {
                ts.forEachChild(node, visit(fileName));
            }
        };
    }
    function optionalMember(s, n) {
        var optional = ((s.flags & ts.SymbolFlags.Optional) == ts.SymbolFlags.Optional);
        var memType = checker.getTypeOfSymbolAtLocation(s, n ? n : s.valueDeclaration);
        return { name: s.name, type: getWithAliasProps(memType), optional: optional };
    }
    function convertProperties(t, n) {
        return t.getProperties().map(function (s) { return optionalMember(s, n); });
    }
    function getWithAliasProps(t) {
        var alias;
        if (t.aliasSymbol) {
            alias = {
                "alias": {
                    "typeReference": getFullyQualifiedName(t.aliasSymbol),
                    "typeParams": t.aliasTypeArguments ? t.aliasTypeArguments.map(getTSType) : []
                }
            };
        }
        else
            alias = {};
        return tslib_1.__assign(tslib_1.__assign({}, alias), getTSType(t));
    }
    function getFullyQualifiedName(s) {
        return checker.getFullyQualifiedName(s);
    }
    function getTSType(memType) {
        if (memType.isUnionOrIntersection()) {
            var unionTypes = memType.types.map(function (v) { return getWithAliasProps(v); });
            return { type: "union", types: unionTypes };
        }
        else if (memType.flags & (ts.TypeFlags.String
            | ts.TypeFlags.BooleanLike | ts.TypeFlags.Number
            | ts.TypeFlags.Null | ts.TypeFlags.VoidLike | ts.TypeFlags.Any)) {
            return { type: checker.typeToString(memType) };
        }
        else if (memType.isStringLiteral()) {
            return { type: "stringLiteral", value: memType.value };
        }
        else if (memType.isNumberLiteral()) {
            return { type: "numberLiteral", value: memType.value };
        }
        var callSigs = memType.getCallSignatures();
        if (callSigs.length > 0) {
            var sig = callSigs[0];
            var params = sig.getParameters().map(function (p) { return optionalMember(p); });
            return { type: "function", params: params, return: getWithAliasProps(sig.getReturnType()) };
        }
        if (memType.flags & (ts.TypeFlags.Object | ts.TypeFlags.NonPrimitive)) {
            var objFlags = memType.objectFlags;
            if (objFlags & ts.ObjectFlags.Reference) {
                var tr = memType;
                return {
                    type: "typeReference",
                    name: memType.symbol ? getFullyQualifiedName(memType.symbol) : '!!!unknown!!!',
                    typeParams: tr.typeArguments ? tr.typeArguments.map(getWithAliasProps) : [],
                    flags: memType.flags,
                    objFlags: objFlags
                };
            }
            else {
                if (objFlags & ts.ObjectFlags.Anonymous) {
                    return {
                        type: "object",
                        members: convertProperties(memType)
                    };
                }
                if (objFlags & ts.ObjectFlags.Interface) {
                    return { type: "interfaceReference", name: getFullyQualifiedName(memType.symbol) };
                }
                return { type: "unknownObject", flags: objFlags };
            }
        }
        else if (memType.flags & ts.TypeFlags.TypeParameter) {
            return { type: "typeparam", name: checker.typeToString(memType) };
        }
        else {
            return { unknown: checker.typeToString(memType), flags: memType.flags };
        }
    }
    function isNodeExported(node) {
        return ((ts.getCombinedNodeFlags(node) & ts.ModifierFlags.Export) !== 0 ||
            (!!node.parent && node.parent.kind === ts.SyntaxKind.SourceFile));
    }
}
exports.readTypes = readTypes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhZFRTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHNyYy9SZWFkVFMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQWlDO0FBR2pDLFNBQWdCLFNBQVMsQ0FDdkIsY0FBc0IsRUFDdEIsT0FBbUQ7SUFHbkQsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDLHlCQUF5QixDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUN0RyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUMsMEJBQTBCLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBRXpILElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFHakUsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBRXZDLElBQUksTUFBTSxHQUFVLEVBQUUsQ0FBQztJQUl2QixLQUF5QixVQUF3QixFQUF4QixLQUFBLE9BQU8sQ0FBQyxjQUFjLEVBQUUsRUFBeEIsY0FBd0IsRUFBeEIsSUFBd0IsRUFBRTtRQUE5QyxJQUFNLFVBQVUsU0FBQTtRQUVqQixFQUFFLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7S0FDM0Q7SUFFRCxPQUFPLE1BQU0sQ0FBQztJQUdkLFNBQVMsS0FBSyxDQUFDLFFBQWdCO1FBQzdCLE9BQU8sVUFBQyxJQUFhO1lBRW5CLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3pCLE9BQU87YUFDUjtZQUVELElBQUksRUFBRSxD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QUFDLElBQUksRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFDLFFBQVEsRUFBQyxDQUFBO2FBQy9DO1NBQ0Y7YUFDSSxJQUFJLE9BQU8sQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQ25EO1lBQ0UsT0FBTyxFQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEVBQUMsQ0FBQTtTQUNoRTthQUNJO1lBQ0gsT0FBTyxFQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxFQUFDLENBQUE7U0FDdEU7SUFDSCxDQUFDO0lBRUQsU0FBUyxjQUFjLENBQUMsSUFBYTtRQUNuQyxPQUFPLENBQ0wsQ0FBQyxFQUFFLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1lBQy9ELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FDakUsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDO0FBdEpELDhCQXNKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHRzIGZyb20gXCJ0eXBlc2NyaXB0XCI7XG5cbi8qKiBHZW5lcmF0ZSBkb2N1bWVudGF0aW9uIGZvciBhbGwgY2xhc3NlcyBpbiBhIHNldCBvZiAudHMgZmlsZXMgKi9cbmV4cG9ydCBmdW5jdGlvbiByZWFkVHlwZXMoXG4gIGNvbmZpZ0ZpbGVuYW1lOiBzdHJpbmcsXG4gIGluY2x1ZGU6IChmaWxlTmFtZTogc3RyaW5nLCBuYW1lOnN0cmluZykgPT4gYm9vbGVhbixcbik6IGFueVtdIHtcbiAgLy8gQnVpbGQgYSBwcm9ncmFtIHVzaW5nIHRoZSBzZXQgb2Ygcm9vdCBmaWxlIG5hbWVzIGluIGZpbGVOYW1lc1xuICB2YXIgY29uZmlnSnNvbiA9IHRzLnBhcnNlQ29uZmlnRmlsZVRleHRUb0pzb24oY29uZmlnRmlsZW5hbWUsIHRzLnN5cy5yZWFkRmlsZShjb25maWdGaWxlbmFtZSkpLmNvbmZpZztcbiAgdmFyIGNvbmZpZyA9IHRzLnBhcnNlSnNvbkNvbmZpZ0ZpbGVDb250ZW50KGNvbmZpZ0pzb24sIHRzLnN5cywgY29uZmlnRmlsZW5hbWUucmVwbGFjZSgvW14vXSskLywgJycpLCB7fSwgY29uZmlnRmlsZW5hbWUpO1xuXG4gIGxldCBwcm9ncmFtID0gdHMuY3JlYXRlUHJvZ3JhbShjb25maWcuZmlsZU5hbWVzLCBjb25maWcub3B0aW9ucyk7XG5cbiAgLy8gR2V0IHRoZSBjaGVja2VyLCB3ZSB3aWxsIHVzZSBpdCB0byBmaW5kIG1vcmUgYWJvdXQgY2xhc3Nlc1xuICBsZXQgY2hlY2tlciA9IHByb2dyYW0uZ2V0VHlwZUNoZWNrZXIoKTtcblxuICBsZXQgb3V0cHV0OiBhbnlbXSA9IFtdO1xuXG5cbiAgLy8gVmlzaXQgZXZlcnkgc291cmNlRmlsZSBpbiB0aGUgcHJvZ3JhbVxuICBmb3IgKGNvbnN0IHNvdXJjZUZpbGUgb2YgcHJvZ3JhbS5nZXRTb3VyY2VGaWxlcygpKSB7XG4gICAgICAvLyBXYWxrIHRoZSB0cmVlIHRvIHNlYXJjaCBmb3IgY2xhc3Nlc1xuICAgICAgdHMuZm9yRWFjaENoaWxkKHNvdXJjZUZpbGUsIHZpc2l0KHNvdXJjZUZpbGUuZmlsZU5hbWUpKTtcbiAgfVxuXG4gIHJldHVybiBvdXRwdXQ7XG5cbiAgLyoqIHZpc2l0IG5vZGVzIGZpbmRpbmcgZXhwb3J0ZWQgY2xhc3NlcyAqL1xuICBmdW5jdGlvbiB2aXNpdChmaWxlTmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIChub2RlOiB0cy5Ob2RlKSA9PiB7XG4gICAgICAvLyBPbmx5IGNvbnNpZGVyIGV4cG9ydGVkIG5vZGVzXG4gICAgICBpZiAoIWlzTm9kZUV4cG9ydGVkKG5vZGUpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKHRzLmlzSW50ZXJmYWNlRGVjbGFyYXRpb24obm9kZSkgJiYgaW5jbHVkZShmaWxlTmFtZSwgbm9kZS5uYW1lLnRleHQpKSB7XG4gICAgICAgIC8vIFRoaXMgaXMgYSB0b3AgbGV2ZWwgY2xhc3MsIGdldCBpdHMgc3ltYm9sXG4gICAgICAgIGxldCBzeW1ib2wgPSBjaGVja2VyLmdldFN5bWJvbEF0TG9jYXRpb24obm9kZS5uYW1lKTtcbiAgICAgICAgaWYgKHN5bWJvbCkge1xuICAgICAgICAgIGxldCBub2RlVHlwZSA9IGNoZWNrZXIuZ2V0VHlwZUF0TG9jYXRpb24obm9kZSk7XG4gICAgICAgICAgaWYgKG5vZGVUeXBlLmlzQ2xhc3NPckludGVyZmFjZSgpKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGxldCBtZW1iZXJzID0gY29udmVydFByb3BlcnRpZXMobm9kZVR5cGUsIG5vZGUpO1xuICAgICAgICAgICAgb3V0cHV0LnB1c2goe3R5cGU6IFwiaW50ZXJmYWNlXCIsIG5hbWU6IG5vZGUubmFtZS50ZXh0LCBtZW1iZXJzfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIE5vIG5lZWQgdG8gd2FsayBhbnkgZnVydGhlciwgY2xhc3MgZXhwcmVzc2lvbnMvaW5uZXIgZGVjbGFyYXRpb25zXG4gICAgICAgIC8vIGNhbm5vdCBiZSBleHBvcnRlZFxuICAgICAgfSBlbHNlIGlmICh0cy5pc01vZHVsZURlY2xhcmF0aW9uKG5vZGUpKSB7XG4gICAgICAgIC8vIFRoaXMgaXMgYSBuYW1lc3BhY2UsIHZpc2l0IGl0cyBjaGlsZHJlblxuICAgICAgICB0cy5mb3JFYWNoQ2hpbGQobm9kZSwgdmlzaXQoZmlsZU5hbWUpKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gb3B0aW9uYWxNZW1iZXIoczogdHMuU3ltYm9sLCBuPzogdHMuTm9kZSkge1xuICAgIGxldCBvcHRpb25hbCA9ICgocy5mbGFncyAmIHRzLlN5bWJvbEZsYWdzLk9wdGlvbmFsKSA9PSB0cy5TeW1ib2xGbGFncy5PcHRpb25hbCk7XG4gICAgbGV0IG1lbVR5cGUgPSBjaGVja2VyLmdldFR5cGVPZlN5bWJvbEF0TG9jYXRpb24ocywgbiA/IG4gOiBzLnZhbHVlRGVjbGFyYXRpb24pO1xuICAgIHJldHVybiB7bmFtZTpzLm5hbWUsIHR5cGU6IGdldFdpdGhBbGlhc1Byb3BzKG1lbVR5cGUpLCBvcHRpb25hbH07XG4gIH1cblxuXG4gIGZ1bmN0aW9uIGNvbnZlcnRQcm9wZXJ0aWVzKHQ6IHRzLlR5cGUsIG4/OiB0cy5Ob2RlKTogYW55IHtcbiAgICByZXR1cm4gdC5nZXRQcm9wZXJ0aWVzKCkubWFwKCAoczogdHMuU3ltYm9sKSA9PiBvcHRpb25hbE1lbWJlcihzLCBuKSApO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0V2l0aEFsaWFzUHJvcHModDogdHMuVHlwZSk6IGFueSB7XG4gICAgbGV0IGFsaWFzO1xuICAgIGlmICh0LmFsaWFzU3ltYm9sKVxuICAgIHtcbiAgICAgIGFsaWFzID0ge1xuICAgICAgICBcImFsaWFzXCI6IHtcbiAgICAgICAgICBcInR5cGVSZWZlcmVuY2VcIjogZ2V0RnVsbHlRdWFsaWZpZWROYW1lKHQuYWxpYXNTeW1ib2wpLFxuICAgICAgICAgIFwidHlwZVBhcmFtc1wiOiB0LmFsaWFzVHlwZUFyZ3VtZW50cyA/IHQuYWxpYXNUeXBlQXJndW1lbnRzLm1hcChnZXRUU1R5cGUpOltdXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgYWxpYXMgPSB7fVxuICAgIHJldHVybiB7Li4uYWxpYXMsIC4uLmdldFRTVHlwZSh0KX1cbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEZ1bGx5UXVhbGlmaWVkTmFtZShzOiB0cy5TeW1ib2wpOiBzdHJpbmcge1xuICAgIHJldHVybiBjaGVja2VyLmdldEZ1bGx5UXVhbGlmaWVkTmFtZShzKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldFRTVHlwZShtZW1UeXBlOiB0cy5UeXBlKTogYW55IHtcbiAgICBpZiAobWVtVHlwZS5pc1VuaW9uT3JJbnRlcnNlY3Rpb24oKSkge1xuICAgICAgbGV0IHVuaW9uVHlwZXMgPSBtZW1UeXBlLnR5cGVzLm1hcCgodjogdHMuVHlwZSkgPT4gZ2V0V2l0aEFsaWFzUHJvcHModikpO1xuICAgICAgcmV0dXJuIHt0eXBlOiBcInVuaW9uXCIsIHR5cGVzOiB1bmlvblR5cGVzfTtcbiAgICB9IGVsc2UgaWYgKG1lbVR5cGUuZmxhZ3MgJiAodHMuVHlwZUZsYWdzLlN0cmluZ1xuICAgICAgICB8dHMuVHlwZUZsYWdzLkJvb2xlYW5MaWtlfHRzLlR5cGVGbGFncy5OdW1iZXJcbiAgICAgICAgfHRzLlR5cGVGbGFncy5OdWxsfHRzLlR5cGVGbGFncy5Wb2lkTGlrZXx0cy5UeXBlRmxhZ3MuQW55KSlcbiAgICB7XG4gICAgICByZXR1cm4ge3R5cGU6IGNoZWNrZXIudHlwZVRvU3RyaW5nKG1lbVR5cGUpfTtcbiAgICB9XG4gICAgZWxzZSBpZiAobWVtVHlwZS5pc1N0cmluZ0xpdGVyYWwoKSlcbiAgICB7XG4gICAgICByZXR1cm4ge3R5cGU6IFwic3RyaW5nTGl0ZXJhbFwiLCB2YWx1ZTogbWVtVHlwZS52YWx1ZX1cbiAgICB9XG4gICAgZWxzZSBpZiAobWVtVHlwZS5pc051bWJlckxpdGVyYWwoKSlcbiAgICB7XG4gICAgICByZXR1cm4ge3R5cGU6IFwibnVtYmVyTGl0ZXJhbFwiLCB2YWx1ZTogbWVtVHlwZS52YWx1ZX1cbiAgICB9XG4gICAgbGV0IGNhbGxTaWdzID0gbWVtVHlwZS5nZXRDYWxsU2lnbmF0dXJlcygpO1xuICAgIGlmIChjYWxsU2lncy5sZW5ndGggPiAwKVxuICAgIHtcbiAgICAgIGxldCBzaWcgPWNhbGxTaWdzWzBdO1xuICAgICAgbGV0IHBhcmFtcyA9IHNpZy5nZXRQYXJhbWV0ZXJzKCkubWFwKChwOiB0cy5TeW1ib2wpID0+IG9wdGlvbmFsTWVtYmVyKHApKTtcbiAgICAgIHJldHVybiB7dHlwZTpcImZ1bmN0aW9uXCIsIHBhcmFtcywgcmV0dXJuOiBnZXRXaXRoQWxpYXNQcm9wcyhzaWcuZ2V0UmV0dXJuVHlwZSgpKSB9O1xuICAgIH1cbiAgICBpZiAobWVtVHlwZS5mbGFncyAmICh0cy5UeXBlRmxhZ3MuT2JqZWN0IHwgdHMuVHlwZUZsYWdzLk5vblByaW1pdGl2ZSkpXG4gICAge1xuICAgICAgbGV0IG9iakZsYWdzID0gKDx0cy5PYmplY3RUeXBlPiBtZW1UeXBlKS5vYmplY3RGbGFncztcbiAgICAgIGlmIChvYmpGbGFncyAmIHRzLk9iamVjdEZsYWdzLlJlZmVyZW5jZSlcbiAgICAgIHtcbiAgICAgICAgbGV0IHRyID0gKDx0cy5UeXBlUmVmZXJlbmNlPiBtZW1UeXBlKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiBcInR5cGVSZWZlcmVuY2VcIixcbiAgICAgICAgICBuYW1lOiBtZW1UeXBlLnN5bWJvbCA/IGdldEZ1bGx5UXVhbGlmaWVkTmFtZShtZW1UeXBlLnN5bWJvbCkgOiAnISEhdW5rbm93biEhIScsXG4gICAgICAgICAgdHlwZVBhcmFtczogdHIudHlwZUFyZ3VtZW50cyA/IHRyLnR5cGVBcmd1bWVudHMubWFwKGdldFdpdGhBbGlhc1Byb3BzKTpbXSxcbiAgICAgICAgICBmbGFnczogbWVtVHlwZS5mbGFncyxcbiAgICAgICAgICBvYmpGbGFnc1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgaWYgKG9iakZsYWdzICYgdHMuT2JqZWN0RmxhZ3MuQW5vbnltb3VzKVxuICAgICAgICB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6IFwib2JqZWN0XCIsXG4gICAgICAgICAgICBtZW1iZXJzOiBjb252ZXJ0UHJvcGVydGllcyggbWVtVHlwZSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9iakZsYWdzICYgdHMuT2JqZWN0RmxhZ3MuSW50ZXJmYWNlKVxuICAgICAgICB7XG4gICAgICAgICAgcmV0dXJuIHt0eXBlOiBcImludGVyZmFjZVJlZmVyZW5jZVwiLCBuYW1lOiBnZXRGdWxseVF1YWxpZmllZE5hbWUobWVtVHlwZS5zeW1ib2wpfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7dHlwZTogXCJ1bmtub3duT2JqZWN0XCIsIGZsYWdzOm9iakZsYWdzfVxuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIGlmIChtZW1UeXBlLmZsYWdzICYgdHMuVHlwZUZsYWdzLlR5cGVQYXJhbWV0ZXIpXG4gICAge1xuICAgICAgcmV0dXJuIHt0eXBlOiBcInR5cGVwYXJhbVwiLCBuYW1lOiBjaGVja2VyLnR5cGVUb1N0cmluZyhtZW1UeXBlKX1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4ge3Vua25vd246IGNoZWNrZXIudHlwZVRvU3RyaW5nKG1lbVR5cGUpLCBmbGFnczogbWVtVHlwZS5mbGFnc31cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBpc05vZGVFeHBvcnRlZChub2RlOiB0cy5Ob2RlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgICh0cy5nZXRDb21iaW5lZE5vZGVGbGFncyhub2RlKSAmIHRzLk1vZGlmaWVyRmxhZ3MuRXhwb3J0KSAhPT0gMCB8fFxuICAgICAgKCEhbm9kZS5wYXJlbnQgJiYgbm9kZS5wYXJlbnQua2luZCA9PT0gdHMuU3ludGF4S2luZC5Tb3VyY2VGaWxlKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==